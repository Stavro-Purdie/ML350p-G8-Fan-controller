<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Fan Control</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/script.js"></script>
</head>
<body>
<h1>HP ML350p Gen8 Fan Dashboard</h1>

<div>
  <p>CPU Temp: <span id="cpu">{{ cpu_temp }}</span> °C</p>
  <p>GPU Temp: <span id="gpu">{{ gpu_temp }}</span> °C</p>
  <p>GPU: <span id="gpu_name"></span> <span id="gpu_power"></span></p>
</div>

<div id="health" style="padding:8px; background:#eef; border:1px solid #ccd; margin:10px 0; display:none;"></div>

<h2>Fan Speeds</h2>
<ul id="fan-speeds" class="meters">
{% for fan in fan_speeds %}
  <li>{{ fan }}%</li>
{% endfor %}
</ul>

<h2>Fan Curve</h2>
<form method="post" action="/update_curve">
  Min Temp: <input type="number" name="minTemp" value="{{ fan_curve.minTemp }}"> °C<br>
  Max Temp: <input type="number" name="maxTemp" value="{{ fan_curve.maxTemp }}"> °C<br>
  Min Speed: <input type="number" name="minSpeed" value="{{ fan_curve.minSpeed }}"> %<br>
  Max Speed: <input type="number" name="maxSpeed" value="{{ fan_curve.maxSpeed }}"> %<br>
  <hr>
  <strong>GPU Curve (optional)</strong><br>
  {% set gpu_curve = fan_curve.get('gpu', {}) %}
  Min Temp: <input type="number" name="gpu_minTemp" value="{{ gpu_curve.get('minTemp', '') }}"> °C<br>
  Max Temp: <input type="number" name="gpu_maxTemp" value="{{ gpu_curve.get('maxTemp', '') }}"> °C<br>
  Min Speed: <input type="number" name="gpu_minSpeed" value="{{ gpu_curve.get('minSpeed', '') }}"> %<br>
  Max Speed: <input type="number" name="gpu_maxSpeed" value="{{ gpu_curve.get('maxSpeed', '') }}"> %<br>
  <hr>
  <strong>Blending</strong><br>
  Mode:
  {% set blend = fan_curve.get('blend', {}) %}
  {% set blend_mode = blend.get('mode', 'max') %}
  <select name="blend_mode">
    <option value="max" {{ 'selected' if blend_mode == 'max' else '' }}>Max(CPU, GPU)</option>
    <option value="weighted" {{ 'selected' if blend_mode == 'weighted' else '' }}>Weighted</option>
  </select><br>
  {% set cpu_w = blend.get('cpuWeight', 0.5) %}
  {% set gpu_w = blend.get('gpuWeight', 0.5) %}
  CPU Weight: <input type="number" step="0.1" name="blend_cpuWeight" value="{{ cpu_w }}"> 
  GPU Weight: <input type="number" step="0.1" name="blend_gpuWeight" value="{{ gpu_w }}"><br>
  <strong>GPU Boost (optional)</strong><br>
  {% set gb = fan_curve.get('gpuBoost', {}) %}
  {% set gb_t = gb.get('threshold', '') %}
  {% set gb_a = gb.get('add', 0) %}
  Threshold (°C): <input type="number" name="gpuBoost_threshold" value="{{ gb_t }}"> 
  Add (%) : <input type="number" name="gpuBoost_add" value="{{ gb_a }}"><br>
  <button type="submit">Update Curve</button>
</form>

<h2>History</h2>
<canvas id="tempChart" height="100"></canvas>
<canvas id="fanChart" height="100"></canvas>
<p><a href="/export_status" target="_blank">Download status JSON</a> • <a href="/export_curve" target="_blank">Download fan curve JSON</a></p>
<p><a href="/debug_ilo_fans" target="_blank">Debug iLO fan objects</a></p>

<h2>Other Sensors</h2>
<table id="sensors" border="1" cellpadding="4" cellspacing="0">
  <thead><tr><th>Sensor</th><th>Value (°C)</th></tr></thead>
  <tbody></tbody>
  </table>

<h2>GPU Info</h2>
<table id="gpuinfo" border="1" cellpadding="4" cellspacing="0">
  <thead>
  <tr>
    <th>Idx</th><th>Name</th><th>Bus</th><th>Temp</th><th>Util</th><th>Enc/Dec</th>
    <th>Mem</th><th>Power</th><th>PState</th><th>Clocks</th><th>PCIe</th><th>NVENC Sessions</th>
  </tr>
  </thead>
  <tbody></tbody>
  </table>

<h2>Service Control</h2>
<form method="post" action="/control">
  <button name="action" value="start">Start Fan Control</button>
  <button name="action" value="stop">Stop Fan Control</button>
</form>

<h3>Fan Test</h3>
<form method="post" action="/fan_test" style="margin-top:8px;">
  Percent: <input type="number" name="test_percent" min="0" max="100" value="100" style="width:70px;"> %
  Duration: <input type="number" name="test_duration" min="1" max="60" value="10" style="width:70px;"> s
  <button type="submit">Run Test</button>
  <small style="color:#555;">Temporarily sets fans, then restores control.</small>
  </form>

</body>
</html>
