<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dynamic Fan Control</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script id="fanCurveData" type="application/json">{{ fan_curve | tojson | safe }}</script>
  <script src="/static/script.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
</head>
<body>
  <div id="updateOverlay" class="update-overlay" aria-hidden="true">Update in progress…</div>
  <h1>HP ML350p Gen8 Fan Dashboard</h1>

  <div>
    <p>CPU Temp: <strong id="cpu">{{ cpu_temp }}</strong> °C</p>
    <p>GPU Temp: <strong id="gpu">{{ gpu_temp }}</strong> °C <span id="gpu_name"></span> <span id="gpu_power"></span></p>
  </div>

  <h2>Fan Speeds</h2>
  <ul id="fan-speeds" class="meters">
    {% if fan_categories and fan_categories|length > 0 %}
      {% for category in fan_categories %}
        <li class="fan-category">
          <div class="fan-category-title">{{ category.name or 'Fans' }}</div>
          <ul class="fan-category-items">
            {% for item in category['items'] %}
              {% set idx = item.index if item.index is defined else loop.index0 %}
              {% set fan_id = item.id if item.id is defined else ('fan' ~ (idx + 1)) %}
              {% set label = item.label if item.label is defined else (fan_labels[idx] if fan_labels and fan_labels|length > idx else fan_id) %}
              {% set speed = item.speed if item.speed is defined else (fan_speeds[idx] if fan_speeds and fan_speeds|length > idx else 0) %}
              <li class="fan-item fan-chill" data-percent="{{ speed }}" data-forecast="{{ speed }}" data-trend="flat">
                <div class="fan-header">
                  <div class="fan-label">
                    <span class="fan-name">{{ label }}</span>
                    <span class="fan-id">{{ fan_id }}</span>
                  </div>
                  <div class="fan-value">{{ speed }}%</div>
                </div>
                <div class="meter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ speed }}">
                  <div class="bar bar-chill" style="--initial-width: {{ speed }}%;"></div>
                </div>
                <div class="fan-trend">
                  <span class="trend-icon trend-flat">→</span>
                  <span class="trend-label">Stable</span>
                  <span class="trend-forecast">30s ≈ {{ speed }}%</span>
                </div>
                <div class="fan-detail">Now {{ speed }}%</div>
              </li>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}
    {% else %}
      {% for s in fan_speeds %}
        {% set idx = loop.index0 %}
        {% set label = fan_labels[idx] if fan_labels and fan_labels|length > idx else 'Fan ' ~ (idx + 1) %}
        {% set group = fan_groups[idx] if fan_groups and fan_groups|length > idx else '' %}
        <li class="fan-item fan-chill" data-percent="{{ s }}" data-forecast="{{ s }}" data-trend="flat">
          <div class="fan-header">
            <div class="fan-label">
              {% if group %}<span class="fan-badge">{{ group }}</span>{% endif %}
              <span class="fan-name">{{ label }}</span>
              <span class="fan-id">fan{{ idx + 1 }}</span>
            </div>
            <div class="fan-value">{{ s }}%</div>
          </div>
          <div class="meter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ s }}">
            <div class="bar bar-chill" style="--initial-width: {{ s }}%;"></div>
          </div>
          <div class="fan-trend">
            <span class="trend-icon trend-flat">→</span>
            <span class="trend-label">Stable</span>
            <span class="trend-forecast">30s ≈ {{ s }}%</span>
          </div>
          <div class="fan-detail">Initial target {{ s }}%</div>
        </li>
      {% endfor %}
    {% endif %}
  </ul>

  <div id="health" style="padding:8px; background:#eef; border:1px solid #ccd; margin:10px 0; display:none;"></div>

  <div id="queueInfo" style="padding:8px; background:#efe; border:1px solid #cfc; margin:10px 0; display:none;"></div>

  <h2>Fan Curve</h2>
  <form method="post" action="/update_curve" data-disable-during-update>
    <label>Min Temp: <input type="number" name="minTemp" value="{{ fan_curve.minTemp }}"> °C</label>
    <label>Max Temp: <input type="number" name="maxTemp" value="{{ fan_curve.maxTemp }}"> °C</label>
    <label>Min Speed: <input type="number" name="minSpeed" value="{{ fan_curve.minSpeed }}"> %</label>
    <label>Max Speed: <input type="number" name="maxSpeed" value="{{ fan_curve.maxSpeed }}"> %</label>
    <fieldset style="margin-top:10px;">
      <legend>GPU Curve (optional)</legend>
      <label>GPU Min Temp: <input type="number" name="gpu_minTemp" value="{{ fan_curve.gpu.minTemp }}"> °C</label>
      <label>GPU Max Temp: <input type="number" name="gpu_maxTemp" value="{{ fan_curve.gpu.maxTemp }}"> °C</label>
      <label>GPU Min Speed: <input type="number" name="gpu_minSpeed" value="{{ fan_curve.gpu.minSpeed }}"> %</label>
      <label>GPU Max Speed: <input type="number" name="gpu_maxSpeed" value="{{ fan_curve.gpu.maxSpeed }}"> %</label>
    </fieldset>
    <fieldset style="margin-top:10px;">
      <legend>Blending</legend>
      <label>Mode:
        <select name="blend_mode">
          <option value="max" {% if fan_curve.blend.mode == 'max' %}selected{% endif %}>Max</option>
          <option value="weighted" {% if fan_curve.blend.mode == 'weighted' %}selected{% endif %}>Weighted</option>
        </select>
      </label>
      <label>CPU Weight: <input step="0.1" type="number" name="blend_cpuWeight" value="{{ fan_curve.blend.cpuWeight }}"></label>
      <label>GPU Weight: <input step="0.1" type="number" name="blend_gpuWeight" value="{{ fan_curve.blend.gpuWeight }}"></label>
    </fieldset>
    <fieldset style="margin-top:10px;">
      <legend>GPU Boost</legend>
      <label>Threshold: <input type="number" name="gpuBoost_threshold" value="{{ fan_curve.gpuBoost.threshold }}"> °C</label>
      <label>Add: <input type="number" name="gpuBoost_add" value="{{ fan_curve.gpuBoost.add }}"> %</label>
    </fieldset>
    <fieldset style="margin-top:10px;">
      <legend>Runtime Tunables</legend>
      <label>Check Interval: <input type="number" name="checkInterval" value="{{ fan_curve.checkInterval or '' }}"> s</label>
      <label>Max Step: <input type="number" name="maxStep" value="{{ fan_curve.maxStep or '' }}"> %/tick</label>
      <label>Min Change: <input type="number" name="minChange" value="{{ fan_curve.minChange or '' }}"> %</label>
    </fieldset>
    <fieldset style="margin-top:10px;">
      <legend>Predictive Control</legend>
      <label>Horizon (s): <input type="number" min="5" name="predict_horizon" value="{{ fan_curve.predict.horizon }}"></label>
      <label>History (samples): <input type="number" min="10" name="predict_history" value="{{ fan_curve.predict.history }}"></label>
      <label>Min Points: <input type="number" min="3" name="predict_minPoints" value="{{ fan_curve.predict.minPoints }}"></label>
      <label>Blend: <input type="number" step="0.05" min="0" max="1" name="predict_blend" value="{{ fan_curve.predict.blend }}"></label>
      <label>GPU Blend: <input type="number" step="0.05" min="0" max="1" name="predict_gpuBlend" value="{{ fan_curve.predict.gpuBlend }}"></label>
      <label>Lead (s): <input type="number" step="0.5" min="0" name="predict_lead" value="{{ fan_curve.predict.lead }}"></label>
      <label>GPU Lead (s): <input type="number" step="0.5" min="0" name="predict_gpuLead" value="{{ fan_curve.predict.gpuLead }}"></label>
      <label>Slope Gain: <input type="number" step="0.05" min="0" name="predict_slopeGain" value="{{ fan_curve.predict.slopeGain }}"></label>
      <label>GPU Slope Gain: <input type="number" step="0.05" min="0" name="predict_gpuSlopeGain" value="{{ fan_curve.predict.gpuSlopeGain }}"></label>
      <label>Max Offset (°C): <input type="number" step="0.5" min="0" name="predict_maxOffset" value="{{ fan_curve.predict.maxOffset }}"></label>
      <label>GPU Max Offset (°C): <input type="number" step="0.5" min="0" name="predict_gpuMaxOffset" value="{{ fan_curve.predict.gpuMaxOffset }}"></label>
      <label>Deadband (Δ%): <input type="number" min="0" name="predict_deadband" value="{{ fan_curve.predict.deadband }}"></label>
      <label>GPU Deadband (Δ%): <input type="number" min="0" name="predict_gpuDeadband" value="{{ fan_curve.predict.gpuDeadband }}"></label>
      <small style="grid-column: 1 / -1; color:#555;">Higher leads and gains increase anticipation, while larger deadbands reduce fan oscillation during idle periods.</small>
    </fieldset>
    <div style="margin-top:8px;"><button type="submit">Update Curve</button></div>
  </form>

  <h2>Service Control</h2>
  <form method="post" action="/control" data-disable-during-update>
    <button name="action" value="start">Start</button>
    <button name="action" value="stop">Stop</button>
  </form>

  <h2>Self Update</h2>
  {% if settings.SELF_UPDATE_ENABLED %}
    <div class="self-update-panel">
      <button type="button" id="selfUpdateButton" onclick="triggerSelfUpdate()">Pull latest from Git</button>
      <div id="selfUpdateStatus" class="status-text">Self-update ready</div>
    </div>
    {% if settings.SELF_UPDATE_PRESERVE %}
      <div class="status-text muted">Preserving: {{ settings.SELF_UPDATE_PRESERVE | join(', ') }}</div>
    {% endif %}
  {% else %}
    <p class="status-text muted">Self-update disabled. Set <code>SELF_UPDATE_ENABLED=1</code> and reload to enable.</p>
  {% endif %}

  <h3>Fan Test</h3>
  <form method="post" action="/fan_test" style="margin-top:8px;" data-disable-during-update>
    Percent: <input type="number" name="test_percent" min="0" max="100" value="100" style="width:70px;"> %
    Duration: <input type="number" name="test_duration" min="1" max="60" value="10" style="width:70px;"> s
    <button type="submit">Run Test</button>
    <small style="color:#555;">Temporarily pauses control service.</small>
  </form>

  <h2>History</h2>
  <canvas id="tempChart" height="100"></canvas>
  <canvas id="fanChart" height="100"></canvas>

  <p>
    <a href="/export_status" target="_blank">Download status JSON</a>
    • <a href="/export_curve" target="_blank">Download fan curve JSON</a>
    • <a href="/test_ilo" target="_blank">Test iLO SSH</a>
    • <a href="/debug_ilo_fans" target="_blank">Debug iLO Fans</a>
  </p>

  <h2>iLO Control Settings</h2>
  <form method="post" action="/settings" style="display:grid; grid-template-columns: repeat(3, minmax(200px, 1fr)); gap:8px; align-items:center;" data-disable-during-update>
    <label>Legacy SSH
      <select name="ILO_SSH_LEGACY"><option value="0" {% if not settings.ILO_SSH_LEGACY %}selected{% endif %}>No</option><option value="1" {% if settings.ILO_SSH_LEGACY %}selected{% endif %}>Yes</option></select>
    </label>
    <label>Force TTY
      <select name="ILO_SSH_TTY"><option value="0" {% if not settings.ILO_SSH_TTY %}selected{% endif %}>No</option><option value="1" {% if settings.ILO_SSH_TTY %}selected{% endif %}>Yes</option></select>
    </label>
    <label>SSH Timeout (s)
      <input type="number" name="ILO_SSH_TIMEOUT" value="{{ settings.ILO_SSH_TIMEOUT }}">
    </label>
    <label>Persist (s)
      <input type="number" name="ILO_SSH_PERSIST" value="{{ settings.ILO_SSH_PERSIST }}">
    </label>
    <label>Modded iLO
      <select name="ILO_MODDED"><option value="0" {% if not settings.ILO_MODDED %}selected{% endif %}>No</option><option value="1" {% if settings.ILO_MODDED %}selected{% endif %}>Yes</option></select>
    </label>
    <label>PID Offset
      <input type="number" name="ILO_PID_OFFSET" value="{{ settings.ILO_PID_OFFSET }}">
    </label>
    <label>Explicit P-IDs (space-separated)
      <input type="text" name="FAN_P_IDS_STR" value="{{ settings.FAN_P_IDS_STR }}">
    </label>
    <fieldset style="grid-column: 1 / -1; border:1px solid #ddd; padding:8px;">
      <legend>Map Fans to P-IDs</legend>
      <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
        {% for f in settings.get('configured_fans', []) or [] %}
          <label>{{ f }} → PID
            <input type="number" name="MAP_{{ f }}" min="0" max="10" placeholder="1">
          </label>
        {% endfor %}
        {% if not settings.get('configured_fans') %}
          <small>Fans not discovered yet; enter P-IDs above in "Explicit P-IDs" or save and refresh.</small>
        {% endif %}
      </div>
      <small>Enter numbers (e.g., 1 for fan2). Leave empty to keep current mapping.</small>
    </fieldset>
    <label>Property (normal mode)
      <input type="text" name="ILO_FAN_PROP" value="{{ settings.ILO_FAN_PROP }}" placeholder="speed|pwm|duty">
    </label>
    <label>Cmd Gap (ms)
      <input type="number" name="ILO_CMD_GAP_MS" value="{{ settings.ILO_CMD_GAP_MS or 75 }}">
    </label>
    <label>Batch Size
      <input type="number" name="ILO_BATCH_SIZE" value="{{ settings.ILO_BATCH_SIZE or 1 }}">
    </label>
    <label>PWM Units
      <select name="PWM_UNITS">
        <option value="percent" {% if settings.PWM_UNITS != 'bits' %}selected{% endif %}>Percent (UI-friendly)</option>
        <option value="bits" {% if settings.PWM_UNITS == 'bits' %}selected{% endif %}>Bits (1..255 raw)</option>
      </select>
    </label>
    <div style="grid-column: 1 / -1; margin-top:6px;"><button type="submit">Save Settings</button></div>
  </form>

  <h2>Recent iLO Commands (server)</h2>
  <button onclick="loadILORecent()" data-disable-during-update>Refresh</button>
  <pre id="iloRecent" style="white-space:pre-wrap; background:#111; color:#0f0; padding:8px; max-height:240px; overflow:auto;"></pre>

  <h2>Daemon Logs (last 80 lines)</h2>
  <button onclick="loadLogs()" data-disable-during-update>Refresh</button>
  <pre id="logs" style="white-space:pre-wrap; background:#222; color:#ddd; padding:8px; max-height:300px; overflow:auto;"></pre>

  <h2>Other Sensors</h2>
  <table id="sensors" border="1" cellpadding="4" cellspacing="0">
    <thead><tr><th>Sensor</th><th>Value (°C)</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>GPU Info</h2>
  <table id="gpuinfo" border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>Idx</th><th>Name</th><th>Bus</th><th>Temp</th><th>Util</th><th>Enc/Dec</th>
        <th>Mem</th><th>Power</th><th>PState</th><th>Clocks</th><th>PCIe</th><th>NVENC Sessions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</body>
</html>
